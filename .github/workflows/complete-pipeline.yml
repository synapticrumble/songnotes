name: Complete Song Notations Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - '**.docx'
      - '**.py'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force complete rebuild'
        required: false
        default: 'false'

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper git operations
        
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright and browsers
      run: |
        playwright install chromium
        playwright install-deps
        
    - name: Create output directory
      run: mkdir -p output
      
    - name: Step 1 - Reformat DOCX (if exists)
      run: |
        if [ -f "songs_reformatted.docx" ] || [ -f "BansuriMusic.docx" ]; then
          echo "ðŸ“ Running document reformatter..."
          python reformat.py || echo "âš ï¸ Reformat step skipped"
        else
          echo "â„¹ï¸ No DOCX files found, skipping reformat step"
        fi
        
    - name: Step 2 - Convert to HTML
      run: |
        echo "ðŸ”„ Converting DOCX to HTML..."
        python convert_and_push.py
        
    - name: Step 3 - Generate PNG and Watermark
      run: |
        echo "ðŸ“¸ Generating PNG images..."
        python render_and_watermark.py
        
    - name: Step 4 - Verify outputs
      run: |
        echo "ðŸ” Verifying generated files..."
        ls -la output/
        if [ -f "output/song_notations.html" ]; then
          echo "âœ… HTML file generated"
        else
          echo "âŒ HTML file missing"
          exit 1
        fi
        
    - name: Step 5 - Commit generated files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add output/
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git commit -m "ðŸ¤– Auto-generated: Updated HTML and PNG files [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push origin main
          echo "âœ… Changes committed and pushed"
        fi
        
    - name: Step 6 - Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        publish_branch: gh-pages
        force_orphan: true
        
    - name: Step 7 - Create deployment summary
      if: always()
      run: |
        echo "## ðŸŽµ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        if [ -f "output/song_notations.html" ]; then
          echo "- **HTML**: âœ… Generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **HTML**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -f "output/song_notations.png" ]; then
          echo "- **PNG**: âœ… Generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **PNG**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Live Site**: https://synapticrumble.github.io/songnotes/song_notations.html" >> $GITHUB_STEP_SUMMARY